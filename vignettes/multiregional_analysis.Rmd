---
title: "Multi-Regional Input-Output Analysis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Multi-Regional Input-Output Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
p.caption {
  font-size: 0.6em;
  text-align: "center";
}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  out.width = "70%"
)
```

# Introduction

Multi-Regional Input-Output (MRIO) analysis extends traditional input-output analysis to capture economic interdependencies between multiple regions or countries. The `miom` class in the `fio` package implements the methodology described in Miller & Blair (2009) for analyzing multi-regional economic systems.

This vignette demonstrates how to:

- Create and work with multi-regional input-output matrices
- Compute multi-regional multipliers
- Analyze inter-regional spillover effects  
- Extract country-specific input-output tables
- Measure regional interdependence

In a multi-regional system with $R$ regions and $N$ sectors per region, the total dimensions of the system are $RN \times RN$. The intermediate transactions matrix $\mathbf{Z}$ is partitioned as:

$$
\mathbf{Z} = \begin{bmatrix}
\mathbf{Z}^{11} & \mathbf{Z}^{12} & \cdots & \mathbf{Z}^{1R} \\
\mathbf{Z}^{21} & \mathbf{Z}^{22} & \cdots & \mathbf{Z}^{2R} \\
\vdots & \vdots & \ddots & \vdots \\
\mathbf{Z}^{R1} & \mathbf{Z}^{R2} & \cdots & \mathbf{Z}^{RR}
\end{bmatrix}
$$

\noindent where $\mathbf{Z}^{rs}$ represents intermediate flows from region $s$ to region $r$.

Computations of the multi-regional Leontief inverse is the same from the single-region case:

$$
\mathbf{L} = (\mathbf{I} - \mathbf{A})^{-1}
$$

\noindent where $\mathbf{A}$ is the multi-regional technical coefficients matrix. Therefore, the multi-regional input-output class `miom` is able to inherit methods from the `iom` class, implementing the additional functionality needed for multi-regional analysis.

# SHOWCASING THE `miom` CLASS: 2000 WORLD ECONOMY EXAMPLE

The `fiodata` package includes the `world_2000` dataset, which contains real multi-regional input-output data for 26 countries and 23 sectors from the year 2000. This dataset was created using element-by-element imports from Excel files with `import_element()` as demonstrated in the [World 2000 script](https://github.com/albersonmiranda/fiodata/blob/main/data-raw/world_2000.R).

Let's load and examine this real-world dataset:

```{r world_data}
# Load the built-in world_2000 dataset
world_2000 <- fiodata::world_2000

# Examine the structure
world_2000$n_countries
world_2000$n_sectors
nrow(world_2000$intermediate_transactions)
ncol(world_2000$intermediate_transactions)

# Show the countries and sectors
world_2000$countries
world_2000$sectors
```

```{r examine_transactions}
# Show a small subset of transactions (first 6 countries x sectors)
knitr::kable(
  world_2000$intermediate_transactions[1:6, 1:6],
  digits = 0,
  caption = "Sample of Intermediate Transactions (millions of dollars)"
)

# Show total production for first few country-sectors
knitr::kable(
  t(world_2000$total_production[1, 1:6]),
  digits = 0,
  caption = "Sample of Total Production (millions of dollars)"
)
```

The intermediate transactions matrix shows the flows of goods and services between all country-sector combinations in the global economy. The values represent monetary flows in millions of dollars. Each element represents purchases of intermediate inputs from the supplying country-sector (columns) by the purchasing country-sector (rows). It captures the complete structure of intermediate transactions between 26 countries across 23 economic sectors, providing a comprehensive view of global economic interdependencies in the year 2000.

## Multi-Regional Multiplier Analysis

The `miom` class computes several types of multipliers following Miller & Blair (2009):

- **Intra-regional multipliers**: Effects within the same region
- **Inter-regional multipliers**: Effects between different regions  
- **Spillover multipliers**: Total effects on other regions
- **Total multipliers**: Sum of intra-regional and spillover effects

```{r compute_multipliers}
world_2000$compute_multiregional_multipliers()

# Show first 10 rows of multipliers for readability
knitr::kable(
  world_2000$multiregional_multipliers[1:10, 1:10],
  digits = 4,
  caption = "Multi-Regional Multipliers (first 10 country-sectors)"
)
```

## Interpreting the Multipliers

The multipliers table shows several key measures for each country-sector combination:

- **Intra-regional multiplier**: The total effect within the same country when that sector receives a $1 shock
- **Spillover multiplier**: The total effect on all other countries from the same shock  
- **Total multiplier**: The sum of intra-regional and spillover effects
- **Multiplier to [Country]**: The specific effect on each individual country

```{r interpret_multipliers}
# Find an interesting example - let's look at Brazil Agriculture -> to USA
bra_agr_index <- which(grepl("BRA.*Agriculture", world_2000$multiregional_multipliers$destination_label))[1]

bra_agr <- world_2000$multiregional_multipliers[bra_agr_index, ]

# Show key multiplier components
multiplier_cols <- c("destination_label", "intra_regional_multiplier", "spillover_multiplier", "total_multiplier", "multiplier_to_USA")
available_cols <- intersect(multiplier_cols, names(bra_agr))
knitr::kable(bra_agr[, available_cols],
  digits = 4,
  caption = "Example: Brazil Agriculture Multipliers"
)
```

The multipliers reveal important insights about global economic linkages. The intra-regional multiplier shows the domestic effect within a country when one of its sectors receives a demand shock, while the spillover multiplier captures the total impact on all other countries.

## Regional Interdependence Analysis

Regional interdependence measures help understand the economic integration between countries. The `get_regional_interdependence()` method computes several key indicators:

- **Self-reliance**: Average intra-regional multiplier (higher values indicate more self-sufficient economies)
- **Spillover out**: Average impact on other regions when this country is shocked
- **Spillover in**: Average sensitivity to shocks from other regions  
- **Interdependence index**: Ratio of spillover to self-reliance

```{r interdependence}
interdependence <- world_2000$get_regional_interdependence()
knitr::kable(interdependence, digits = 4)
```

The results show that `r interdependence$country[which.max(interdependence$self_reliance)]` has the highest self-reliance (`r round(max(interdependence$self_reliance), 4)`), indicating a more self-sufficient economy. Meanwhile, `r interdependence$country[which.max(interdependence$interdependence_index)]` has the highest interdependence index (`r round(max(interdependence$interdependence_index), 4)`), suggesting greater integration with other economies.

## Bilateral Trade Analysis

The `miom` class allows extraction of bilateral trade flows between any two countries using the `get_bilateral_trade()` method:

```{r bilateral_trade}

# Get bilateral trade flows
trade_flow1 <- world_2000$get_bilateral_trade("BRA", "USA")
knitr::kable(trade_flow1[1:10, 1:5],
  digits = 2,
  caption = paste("Trade flows from", "BRA", "to", "USA", "(first 10 buying sectors, first 5 supplying sectors)")
)

trade_flow2 <- world_2000$get_bilateral_trade("USA", "BRA")
knitr::kable(trade_flow2[1:10, 1:5],
  digits = 2,
  caption = paste("Trade flows from", "USA", "to", "BRA", "(first 10 buying sectors, first 5 supplying sectors)")
)
```

These matrices show the intermediate goods flows from the origin country (columns) to the destination country (rows) by sector. The values represent the monetary flows of intermediate inputs used in production.

## Spillover Matrix

The spillover matrix provides a comprehensive view of how shocks in each country-sector affect all other country-sectors in the system:

```{r spillover_matrix}
spillover_matrix <- world_2000$get_spillover_matrix()
```

This $598 \times 598$ matrix contains the complete set of multiplier effects. For example, we can examine how a shock to the US electrical sector affects manufacturing in other countries:

```{r us_effects}

# Effects of a shock to US Electrical sector
electrical_effects <- spillover_matrix[grepl("*_Manufacturing, recycling", rownames(spillover_matrix)), "USA_Electrical and optical equipment"]
knitr::kable(
  electrical_effects,
  digits = 4,
  caption = "Effects of a unit shock to US Electrical sector"
)
```

These values show the output response in each foreign country-sector to a unit shock in USA Electrical and optical equipment.

## Net Spillover Effects

Net spillover effects reveal asymmetric economic relationships between countries. Positive values indicate that the row country benefits more from economic activity in the column country than vice versa.

```{r net_spillover}
net_spillover <- world_2000$get_net_spillover_matrix()
knitr::kable(net_spillover, digits = 4, caption = "Net Spillover Effects Matrix")
```

The interpretation is straightforward:

- Positive values: row country benefits more from column country
- Negative values: column country benefits more from row country  
- Values close to zero: symmetric spillover relationship

For example, the USA has positive net spillover effects with every other country, indicating it generally benefits more from economic interactions with the world.

## Key Sectors Analysis

Key sectors analysis identifies sectors with strong backward and forward linkages in the multi-regional system:

```{r key_sectors}
world_2000$compute_key_sectors()

key_sectors_table <- world_2000$key_sectors[, c(
  "country", "sector_name",
  "power_dispersion", "sensitivity_dispersion", "key_sectors"
)]
knitr::kable(head(key_sectors_table), digits = 4, caption = "Key Sectors Analysis")
```

Key sectors are defined as those with above-average values in both power dispersion (backward linkages) and sensitivity dispersion (forward linkages). If both values exceed 1, the sector is classified as a key sector.

```{r identify_key_sectors}
knitr::kable(
  subset(key_sectors_table, key_sectors == "Key Sector"),
  digits = 4,
  caption = "World Key Sectors"
)
```

## Extracting Country-Specific Input-Output Tables

Lastly, one can obtain single-region `iom` objects from the multi-regional system. The `extract_country()` method allows you to extract domestic input-output tables for individual countries from the multi-regional system:

```{r extract_country}
# Extract domestic economy for deutschland in the dataset
deutsch_iom <- world_2000$extract_country("DEU")
```

The extracted `iom` object contains only the domestic transactions for the specified country:

```{r country_tables}
# Show a subset of the domestic intermediate transactions
knitr::kable(deutsch_iom$intermediate_transactions[1:8, 1:8],
  digits = 0,
  caption = paste("Deutschland Domestic Intermediate Transactions (first 8x8 sectors, millions USD)")
)

# Show total production
knitr::kable(t(deutsch_iom$total_production[1, 1:12]),
  digits = 0,
  caption = paste("Deutschland Total Production (first 12 sectors, millions USD)")
)
```

You can then perform standard input-output analysis on the domestic economy:

```{r country_analysis}
deutsch_iom$compute_tech_coeff()$compute_leontief_inverse()$compute_multiplier_output()

knitr::kable(head(deutsch_iom$multiplier_output, 12),
  digits = 4,
  caption = paste("Deutschland Domestic Output Multipliers (first 12 sectors)")
)
```

# REFERENCES

Miller, Ronald E., and Peter D. Blair. Input-Output Analysis: Foundations and Extensions. 2nd ed. Cambridge University Press, 2009. https://doi.org/10.1017/CBO9780511626982.
